---
output:
  pdf_document: default
  html_document: default
---
## Stats500 Homework 5
#### *Di Lu, Oct.18, 2017*

### Q1. Based on Chapter 4, Problem 5(p. 97) 
#### 1. build a linear model of taste on Acetic, H2S and Latic

```{r}
library(faraway)
attach(cheddar)
lmod <- lm(taste~Acetic+H2S+Lactic)
# summary(lmod)
```

#### 2. Check the constant variance assumption for the errors and for evidence of non-linearity via residual plots, and adjust model as appropriate

Plot residual against fitted values, we can see residuals are roughly symmetrically distributed, and there is no clear evidence of non-linearity. Plot absolute residual against fitted values, and regress abs(redisual) against fitted value, coefficient of fitted value is not significant at 5% level(p=0.2267). We find no clear evidence against constant variance assumption, so we can carry on with this model.
```{r out.width= '90%', fig.align="center"}
par(mfrow=c(1,2))
plot(fitted(lmod),residuals(lmod),xlab="Fitted Values",ylab="Residuals")
abline(h=0) # a diagnostic residual plot
plot(fitted(lmod),abs(residuals(lmod)),xlab="Fitted Values",ylab="|Residuals|")
abline(h=0)
#summary(lm(abs(lmod$residual)~lmod$fitted))
```

#### 3. Check the structure of the relationship between the predictors and response
To discover which predictor has a non-linear relationship with the response, firstly we plot residuals against predictors, from graphs below, we can no significant non-linear relationships exist.
```{r out.width= '80%', fig.align="center"}
par(mfrow=c(1,3))
plot(Acetic,residuals(lmod),xlab="Acetic",ylab="Residuals")
abline(h=0)
plot(H2S,residuals(lmod),xlab="H2S",ylab="Residuals")
abline(h=0)
plot(Lactic,residuals(lmod),xlab="Lactic",ylab="Residuals")
abline(h=0)
```

Secondly, we use partial regression plot to isolate affect of one predictor on responce, so plot their residuals controlling other variables. From graphs below, we see no significant non-linear relasionships.
```{r echo=FALSE, fig.align="center", out.width='80%'}
par(mfrow=c(1,3))
delta <- residuals(lm(taste~H2S+Lactic))
gamma <- residuals(lm(Acetic~H2S+Lactic))
plot(gamma,delta,xlab="Acetic Residuals",ylab="taste residuals")
temp <- lm(delta ~ gamma)
abline(reg=temp)
delta2 <- residuals(lm(taste~Acetic+Lactic))
gamma2 <- residuals(lm(H2S~Acetic+Lactic))
plot(gamma2,delta2,xlab="H2S Residuals",ylab="taste residuals")
temp2 <- lm(delta2 ~ gamma2)
abline(reg=temp2)
delta3 <- residuals(lm(taste~Acetic+H2S))
gamma3 <- residuals(lm(Lactic~Acetic+H2S))
plot(gamma3,delta3,xlab="Lactic Residuals",ylab="taste residuals")
temp3 <- lm(delta3 ~ gamma3)
abline(reg=temp3)
```

Lastly, we use partial esidual plots to see, eg. Acetics, have no non-linear relationship with responces. The other two variables show no anomolies as well. So we can carry on with this model.
```{r out.width= '70%', fig.align="center"}
plot(Acetic,lmod$residuals+coef(lmod)['Acetic']*Acetic,xlab="Acetic",ylab="taste(adjusted for Acetic)")
abline(a=0,b=coef(lmod)["Acetic"])
```


#### 4. Check the normality assumption
We use QQ-plot to check normality assumption of residuals. Residuals follow the "ideal normal distribution" line approximately, the three largest residuals are above qqline, sending an alarming signal. Shapiro test (p=0.8312) shows not enough evidence to reject normality hypothesis, so we take the normally assumption of this model as true.
```{r out.width= '70%', fig.align="center"}
qqnorm(lmod$residuals,ylab = "Residuals")
qqline(lmod$residuals)
# shapiro.test(lmod$residuals)
```

#### 5. Check for large leverage points
We would like to identify unusually large values of the leverage in half-normal plot. We can see obs.20 and 26 diverge slightly farther from the rest of the data. By rule of thumb, we have no data points whose leverages are greater than 2(p+1)/n = 2(3+1)/30=0.266.
On the other hand, studentized residuals adjust residuals to equal variance, thus at higher leverage points can correct natural non-constant variance in residuals.
```{r out.width= '90%', fig.align="center"}
par(mfrow=c(1,2))
halfnorm(lm.influence(lmod)$hat,nlab=2,ylab = "Leverage",main="Half-normal plot")
abline(h=2*(3+1)/30)
qqnorm(rstandard(lmod))
abline(0,1)
```

#### 6. Check for outliers
We compute jacknife residuals for the sat data and pick out the largest. By applying Bonferroni correction criteria at a level alpha=5% test(that is 0.05/30 = 0.00167), p-value for largest studentized residuals obs.15 is 0.005817, we don't have enough evidence to reject null hypothes point 15 is an outlier. For other points, we can not reject either.
```{r}
ti<-rstudent(lmod)
max(abs(ti))
cheddar[which.max(abs(ti)),]
2*(1-pt(max(abs(ti)),df=30-(3+1)-1))
0.05/30
```

#### 7. Check for influential points
Cook distance combines the residual effect and leverage effect, we use it to diagnose influencial points. The obs.15 has largest cook's distance, followed by obs.12 and 30. If we remove obs.15 from regression, we have Lastic coefficient turns significant at 1%.(previously p-value=0.03108) and R-square increased to 0.7083(previously 0.6518). If we plot change in beta 3 against change in beta 2, we see no point diverge extremely far from the the rest points.
```{r out.width= '90%', fig.align="center"}
par(mfrow=c(1,2))
cook<-cooks.distance(lmod)
halfnorm(cook,nlab = 3, ylab="Cook's Distance")
inf = lm.influence(lmod)
plot(inf$coef[,2],inf$coef[,3],xlab = "change in beta2", ylab = "change in beta3")
```